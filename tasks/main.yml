---
# Install and run elasticsearch

- name: Load a variable file based on the OS type, or a default if not found.
  include_vars: '{{ platform_vars }}'
  with_first_found:
    - '{{ ansible_os_family }}.yml'
    - default.yml
  loop_control:
    loop_var: platform_vars

- name: Load a variable file based on the service manager
  include_vars: '{{ service_manager }}'
  with_first_found:
    - '{{ ansible_service_mgr }}.yml'
    - systemv.yml
  loop_control:
    loop_var: service_manager

- name: "Set oss package variables if oss installation selected"
  set_fact:
    es_package_name: elasticsearch-oss
    es_repo_name: 'oss-{{ es_major_version }}'
  when: es_use_oss_version | bool

- name: "Configure and install packages for current OS"
  include_tasks: '{{ platform_tasks }}'
  with_first_found:
    - 'system/{{ ansible_os_family }}.yml'
    - system/not-supported.yml
  loop_control:
    loop_var: platform_tasks

- name: "Correcting elasticsearch default settings"
  include_tasks: es-settings.yml
  when: elasticsearch_set_settings

- name: "Installing elasticsearch scripts"
  include_tasks: add-scripts.yml
  when: elasticsearch_scripts_install

- name: "Start elasticsearch"
  service:
    name: elasticsearch
    state: started
    enabled: True
  become: True
